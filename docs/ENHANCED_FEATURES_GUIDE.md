# Enhanced Features Interpretation Guide

This guide explains how to interpret the columns in the enhanced features CSV file generated by the `extract-enhanced` command. The enhanced features provide multi-scale chromatin texture analysis, cell cycle state inference, and spatial organization metrics.

---

## Table of Contents

1. [Wavelet Features](#1-wavelet-features-multi-scale-texture-analysis)
2. [Fractal Features](#2-fractal-features-self-similarity)
3. [Chromatin Domain Features](#3-chromatin-domain-features-segmented-domains)
4. [Radial Intensity Profile](#4-radial-intensity-profile-nuclear-compartmentalization)
5. [Cell Cycle Features](#5-cell-cycle-features-replication-and-condensation)
6. [Cell Cycle State Predictions](#6-cell-cycle-state-predictions)
7. [Identifiers](#7-identifiers)
8. [How to Use These Features](#how-to-use-these-features)
9. [Expected Biological Patterns](#expected-biological-patterns)
10. [Quick Reference](#quick-reference-tables)

---

## 1. Wavelet Features (Multi-scale texture analysis)

These capture chromatin organization at different spatial scales:

### Approximation (Low-frequency) Features

- **`wavelet_approx_energy`**: Low-frequency energy (overall nuclear structure)
  - **Higher** = more uniform chromatin distribution
  - **Lower** = more heterogeneous/compartmentalized

- **`wavelet_approx_entropy`**: Information content in low frequencies
  - **Higher** = more complex overall structure

### Detail Energy Features (by Level and Direction)

- **`wavelet_h_energy_l1/l2/l3`**: Horizontal detail energy at levels 1, 2, 3
  - Captures horizontal chromatin patterns
  - **Level 1** = fine scale (1-2 pixels)
  - **Level 2** = medium scale (5-10 pixels)
  - **Level 3** = coarse scale (20-50 pixels)

- **`wavelet_v_energy_l1/l2/l3`**: Vertical detail energy
  - Captures vertical chromatin patterns

- **`wavelet_d_energy_l1/l2/l3`**: Diagonal detail energy
  - Captures diagonal/oriented patterns

- **`wavelet_total_energy_l1/l2/l3`**: Total detail energy per level
  - **Higher** = more texture variation at that scale

### Anisotropy Features

- **`wavelet_anisotropy_l1/l2/l3`**: Horizontal vs vertical dominance
  - **> 0** = horizontal patterns dominate
  - **< 0** = vertical patterns dominate
  - **≈ 0** = isotropic texture

### Texture Complexity

- **`wavelet_fine_coarse_ratio`**: Ratio of fine (L1) to coarse (L3) detail
  - **Higher** = more fine-scale texture relative to large-scale patterns
  - **Lower** = more large-scale organization

---

## 2. Fractal Features (Self-similarity)

- **`fractal_dimension`**: Measures how space-filling the chromatin pattern is (range: 1.0-2.0)
  - **Higher** (closer to 2.0) = more space-filling, complex patterns
  - **Lower** (closer to 1.0) = simpler, more linear patterns
  - **Typical range**: 1.5-1.7 for chromatin

- **`lacunarity`**: Measures texture heterogeneity
  - **Higher** = more gaps/heterogeneity in the pattern
  - **Lower** = more uniform texture

---

## 3. Chromatin Domain Features (Segmented domains)

- **`n_chromatin_domains`**: Number of distinct chromatin domains detected
  - More domains = more compartmentalized chromatin

- **`domain_area_mean/median/max/std`**: Domain size statistics
  - Larger domains = more organized chromatin compartments

- **`domain_area_total`**: Total area of all domains

- **`domain_area_fraction`**: Fraction of nucleus covered by domains
  - **Higher** = more of nucleus is in defined domains

- **`domain_circularity_mean/std`**: How round the domains are
  - **Higher** = more circular domains

- **`domain_size_power_exponent`**: Power-law exponent of domain size distribution
  - Characterizes the scale-free nature of chromatin organization

---

## 4. Radial Intensity Profile (Nuclear compartmentalization)

- **`radial_intensity_bin1` through `radial_intensity_bin5`**: Mean intensity at 5 radial zones (center to edge)
  - **Bin 1** = center
  - **Bin 5** = periphery
  - **Higher center intensity** = more heterochromatin in center
  - **Higher periphery intensity** = more euchromatin at edges

- **`radial_intensity_gradient`**: Rate of change from center to edge
  - **Positive** = intensity increases toward edge (typical)
  - **Negative** = intensity decreases toward edge (unusual)

- **`radial_intensity_ratio`**: Center/periphery ratio
  - **> 1** = brighter center (heterochromatin-rich)
  - **< 1** = brighter periphery (euchromatin-rich)

---

## 5. Cell Cycle Features (Replication and condensation)

- **`n_bright_foci`**: Number of bright replication foci detected
  - **Higher in S phase** (active DNA replication)

- **`bright_foci_fraction`**: Fraction of nucleus with bright foci
  - **Higher** = more active replication

- **`mean_foci_size` / `foci_size_std`**: Size statistics of replication foci

- **`chromatin_condensation_score`**: Local variance measure
  - **Higher** = more condensed chromatin (G2/M phase)
  - **Lower** = more decondensed (G0/G1)

- **`nuclear_circularity`**: 4π×area/perimeter²
  - **Higher** = more round (typical in G0/G1)
  - **Lower** = more irregular (may indicate mitosis)

- **`nuclear_solidity`**: Area/convex_area
  - **Higher** = more convex shape
  - **Lower** = more indented/irregular

- **`intensity_kurtosis`**: Tailedness of intensity distribution
  - **Higher** = more extreme values (peaks/valleys)
  - **Lower** = more uniform distribution

- **`intensity_skewness`**: Asymmetry of intensity distribution
  - **Positive** = right-skewed (few bright spots)
  - **Negative** = left-skewed (few dark spots)

- **`intensity_bimodality`**: Bimodality coefficient
  - **Higher** = more bimodal (typical in S phase with replication foci)
  - **Lower** = more unimodal

---

## 6. Cell Cycle State Predictions

- **`cell_cycle_phase`**: Predicted phase
  - **"G0/G1"** = quiescent/early
  - **"S"** = synthesis (replication)
  - **"G2/M"** = late/pre-mitotic

- **`cell_cycle_prob_G0G1` / `cell_cycle_prob_S` / `cell_cycle_prob_G2M`**: Probabilities for each phase
  - Sum to 1.0
  - **Higher probability** = more confident prediction

- **`cell_cycle_confidence`**: Overall confidence (max probability)
  - **Higher** = more confident prediction

- **`is_proliferating`**: Boolean
  - **True** = S or G2/M phase
  - **False** = G0/G1 phase

---

## 7. Identifiers

- **`image`**: Image identifier
- **`nuc_id`**: Unique nucleus identifier (format: `{image}_{label}`)

---

## How to Use These Features

### For DZ/LZ Classification:

```python
import pandas as pd

df = pd.read_csv('enhanced_features.csv')

# DZ cells typically have:
# - Higher wavelet_fine_coarse_ratio (more fine texture)
# - More replication foci (n_bright_foci)
# - Higher is_proliferating rate
# - Smaller voronoi_area (denser packing)

# LZ cells typically have:
# - Lower fine_coarse_ratio
# - More G0/G1 cells
# - Larger voronoi_area
```

### For Cell Cycle Analysis:

```python
# Stratify by cell cycle
g0g1 = df[df['cell_cycle_phase'] == 'G0/G1']
s_phase = df[df['cell_cycle_phase'] == 'S']
g2m = df[df['cell_cycle_phase'] == 'G2/M']

# Compare chromatin features across phases
print(g0g1[['fractal_dimension', 'chromatin_condensation_score']].mean())
print(s_phase[['fractal_dimension', 'chromatin_condensation_score']].mean())
```

### For Spatial Analysis:

If spatial graph features are present (they may not be in this file if `extract_spatial_graph=False`):
- **`degree_centrality`**: Cells with high values are hubs
- **`betweenness_centrality`**: Bridge cells between zones
- **`voronoi_area`**: Local cell density (inverse)

---

## Expected Biological Patterns

### 1. DZ (Dark Zone - proliferative):
   - **Higher** `is_proliferating`
   - **More** `n_bright_foci` (S phase cells)
   - **Higher** `wavelet_fine_coarse_ratio`
   - **Smaller** `voronoi_area` (denser)

### 2. LZ (Light Zone - selection):
   - **Lower** `is_proliferating`
   - **More** G0/G1 cells
   - **Lower** `wavelet_fine_coarse_ratio`
   - **Larger** `voronoi_area`

### 3. Cell cycle progression:
   - **G0/G1 → S**: Increase in `n_bright_foci`, `intensity_bimodality`
   - **S → G2/M**: Increase in `chromatin_condensation_score`, `nuclear_circularity` decreases

---

## Quick Reference Tables

### Feature Categories Summary

| Category | Key Features | Primary Use Case |
|----------|-------------|------------------|
| **Wavelet** | `wavelet_*_energy_*`, `wavelet_fine_coarse_ratio` | Texture at multiple scales |
| **Fractal** | `fractal_dimension`, `lacunarity` | Self-similarity and complexity |
| **Domain** | `n_chromatin_domains`, `domain_area_*` | Chromatin compartmentalization |
| **Radial** | `radial_intensity_bin*`, `radial_intensity_gradient` | Nuclear compartmentalization |
| **Cell Cycle** | `cell_cycle_phase`, `n_bright_foci` | Proliferation state |
| **Spatial** | `voronoi_area`, `degree_centrality` | Spatial organization |

### DZ vs LZ Signatures

| Feature | DZ (Dark Zone) | LZ (Light Zone) |
|---------|----------------|-----------------|
| `is_proliferating` | Higher (True) | Lower (False) |
| `n_bright_foci` | More S-phase cells | Fewer S-phase cells |
| `wavelet_fine_coarse_ratio` | Higher | Lower |
| `voronoi_area` | Smaller (denser) | Larger (less dense) |
| `cell_cycle_phase` | More S/G2/M | More G0/G1 |

### Wavelet Scale Interpretation

| Level | Scale (pixels) | Biological Process | Key Features |
|-------|---------------|-------------------|--------------|
| L1 | 1-2 | Heterochromatin boundaries | `wavelet_*_energy_l1` |
| L2 | 5-10 | TAD-like structures | `wavelet_*_energy_l2` |
| L3 | 20-50 | Nuclear compartments | `wavelet_*_energy_l3` |

### Cell Cycle Phase Characteristics

| Phase | Nuclear Size | Chromatin Texture | Key Indicators |
|-------|-------------|-------------------|----------------|
| **G0/G1** | Small-medium | Uniform, decondensed | Low `n_bright_foci`, low `chromatin_condensation_score` |
| **S** | Medium-large | Heterogeneous (foci) | High `n_bright_foci`, high `intensity_bimodality` |
| **G2/M** | Large | Condensed | High `chromatin_condensation_score`, lower `nuclear_circularity` |

---

## Feature Extraction Command

To generate enhanced features:

```bash
gc-pipeline extract-enhanced \
    --raw-images data/raw \
    --labels data/labels \
    --output features/enhanced \
    --extract-multiscale \
    --extract-cell-cycle \
    --extract-spatial-graph
```

See `docs/PIPELINE_ENHANCEMENTS.md` for detailed usage instructions.

---

## Visualization

Use the provided visualization script to explore your features:

```bash
# Basic usage
python scripts/visualize_enhanced_features.py \
    --features data/dataset1/processed/features_enhanced/enhanced_features/enhanced_features.csv \
    --output data/dataset1/processed/analysis/enhanced_features_analysis/

# With DZ/LZ comparison
python scripts/visualize_enhanced_features.py \
    --features data/dataset1/processed/features_enhanced/enhanced_features/enhanced_features.csv \
    --output data/dataset1/processed/analysis/enhanced_features_analysis/ \
    --dz-label-col predicted

# Group by cell cycle phase
python scripts/visualize_enhanced_features.py \
    --features data/dataset1/processed/features_enhanced/enhanced_features/enhanced_features.csv \
    --output data/dataset1/processed/analysis/enhanced_features_analysis/ \
    --group-by cell_cycle_phase
```

This generates:
- Feature distribution plots by category
- Cell cycle phase analysis
- Wavelet scale analysis
- DZ/LZ feature comparisons (if labels available)
- Feature correlation matrix
- Summary statistics CSV

---

## References

- **Wavelet Analysis**: Multi-scale texture decomposition for chromatin organization
- **Fractal Dimension**: Box-counting method for self-similarity measurement
- **Cell Cycle Inference**: Threshold-based and clustering-based methods
- **Spatial Graph**: Voronoi tessellation and network analysis

For more details on implementation, see:
- `src/features/multiscale_features.py` - Wavelet and fractal features
- `src/features/cell_cycle.py` - Cell cycle inference
- `src/analysis/spatial_graph.py` - Spatial graph features
