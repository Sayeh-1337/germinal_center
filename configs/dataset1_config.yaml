# Dataset 1 Configuration
# Germinal Center B-cell analysis with DAPI, CD3, and AICDA staining
dataset_name: "dataset1"
input_dir: "data/dataset1/images/raw/merged"
output_dir: "data/dataset1/processed"

# Preprocessing configuration
preprocessing:
  merged_image_dir: "data/dataset1/images/raw/merged"
  channels:
    dapi: 1
    cd3: 2
    aicda: 3
  quantile_normalization:
    enabled: true
    quantiles: [0.01, 0.998]
    mask_dir: "data/dataset1/images/germinal_center_anno"

# Nuclear segmentation using StarDist
segmentation:
  input_dir: null  # Will use preprocessed dapi_scaled automatically
  output_labels_dir: null  # Will default to output_dir/segmented_nucleus
  output_rois_dir: null  # Will default to output_dir/segmented_nuclei_rois
  prob_thresh: 0.43
  use_pretrained: true

# Feature extraction
feature_extraction:
  raw_image_dir: null  # Will use dapi_scaled automatically
  labels_dir: null  # Will use segmented_nucleus automatically
  output_dir: null  # Will default to output_dir/features or features_enhanced
  cell_segmentation:
    enabled: true
    dilation_radius: 10
  extract_spatial: true
  # Germinal center mask directory for inside/outside GC classification
  gc_mask_dir: "data/dataset1/images/germinal_center_anno"
  protein_measurement:
    enabled: true
    proteins:
      - name: "cd3"
        image_dir: "data/dataset1/processed/cd3"
      - name: "aicda"
        image_dir: "data/dataset1/processed/aicda"
  
  # Enhanced features (NEW) - extracts 300+ features instead of 200+
  # Set to false to use standard feature extraction only
  use_enhanced_features: true
  enhanced_features:
    # Multi-scale wavelet and fractal analysis
    extract_multiscale: true
    wavelet_levels: 3  # Number of wavelet decomposition levels
    
    # Cell cycle state inference (G1, S, G2/M phases)
    extract_cell_cycle: true
    
    # Spatial graph-based features (centrality, Voronoi tessellation)
    extract_spatial_graph: true
    k_neighbors: 10  # Number of neighbors for spatial graph
    
    # Relative and interaction features (neighborhood normalization)
    extract_relative: true
    density_radii: [10.0, 25.0, 50.0]  # Radii for local density computation

# Analysis configuration
analysis:
  # Features directory: auto-detected based on use_enhanced_features flag
  # - If enhanced: output_dir/features_enhanced/consolidated_features
  # - If standard: output_dir/features/consolidated_features
  features_dir: null
  output_dir: null  # Will default to output_dir/analysis
  metadata: null  # Optional metadata file for correlation analysis
  
  # Global analysis parameters
  correlation_threshold: 0.8  # Remove features with correlation above this
  random_seed: 1234
  generate_plots: true  # Generate visualization plots
  n_permutations: 10000  # Number of permutations for statistical tests
  
  # Spatial analysis parameters
  spatial_parameters:
    pixel_size: 0.3225  # microns per pixel
    contact_radius: 15.0  # T-cell physical contact radius in microns
    signaling_radius: 30.0  # T-cell signaling radius in microns
    border_threshold: 0.4  # Threshold for DZ/LZ border proximity
  
  # Filter to only cells inside germinal center (like notebook)
  filter_gc_inside: true
  
  # Feature name mapping file (optional, for readable feature names)
  feature_description_file: "data/other/chrometric_feature_description.csv"
  
  # Raw image directory for overlay visualizations
  raw_image_dir: "data/dataset1/images/raw/merged"
  
  # Analysis types to run
  analyses:
    # Cell type detection using GMM thresholding on marker intensities
    - type: "cell_type_detection"
      enabled: true
      description: "Detect DZ B-cells, LZ B-cells, and T-cells using AICDA/CD3 markers"
    
    # DZ vs LZ B-cell classification using Random Forest
    - type: "cell_type"
      enabled: true
      description: "Train classifier to distinguish DZ vs LZ B-cells"
    
    # T-cell interaction zone analysis (all B-cells)
    - type: "tcell_interaction"
      enabled: true
      description: "Analyze B-cell features based on proximity to T-cells"
    
    # DZ B-cells only: T-cell interaction analysis
    - type: "tcell_interaction_dz"
      enabled: true
      description: "T-cell interaction analysis for DZ B-cells only"
    
    # LZ B-cells only: T-cell interaction analysis
    - type: "tcell_interaction_lz"
      enabled: true
      description: "T-cell interaction analysis for LZ B-cells only"
    
    # DZ prediction probability analysis
    - type: "dz_prediction_probability"
      enabled: true
      description: "Train on non-interactors, use DZ probability as phenotype proxy"
    
    # Fraction of T-cell interactors comparison between DZ/LZ
    - type: "tcell_fraction_comparison"
      enabled: true
      description: "Compare frequency of T-cell interacting B-cells in DZ vs LZ"
    
    # DZ/LZ boundary distance analysis
    - type: "boundary"
      enabled: true
      description: "Analyze chrometric differences near DZ/LZ boundary"
    
    # DZ B-cells: close vs distant to boundary
    - type: "boundary_dz"
      enabled: true
      description: "Classify DZ B-cells based on proximity to DZ/LZ boundary"
    
    # LZ B-cells: close vs distant to boundary
    - type: "boundary_lz"
      enabled: true
      description: "Classify LZ B-cells based on proximity to DZ/LZ boundary"
    
    # UMAP visualization and clustering
    - type: "umap"
      enabled: true
      description: "Generate UMAP embedding and HDBSCAN clustering"
    
    # Marker/differential feature analysis
    - type: "markers"
      enabled: true
      description: "Find significantly different features between groups"
    
    # Correlation analysis (requires metadata file)
    - type: "correlation"
      enabled: false
      description: "Correlate features with external metadata"
